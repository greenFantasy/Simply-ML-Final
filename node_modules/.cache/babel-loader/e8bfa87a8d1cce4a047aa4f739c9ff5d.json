{"ast":null,"code":"import { isArray } from 'vega-util';\nimport { FACET_CHANNELS } from '../../channel';\nimport { vgField } from '../../channeldef';\nimport { HEADER_LABEL_PROPERTIES, HEADER_LABEL_PROPERTIES_MAP, HEADER_TITLE_PROPERTIES, HEADER_TITLE_PROPERTIES_MAP } from '../../header';\nimport { isSortField } from '../../sort';\nimport { isFacetMapping } from '../../spec/facet';\nimport { contains, keys, replaceAll } from '../../util';\nimport { defaultLabelAlign, defaultLabelBaseline } from '../axis/properties';\nimport { formatSignalRef } from '../common';\nimport { sortArrayIndexField } from '../data/calculate';\nimport { isFacetModel } from '../model';\nimport { getHeaderChannel, getHeaderProperties, getHeaderProperty } from './common';\nimport { HEADER_TYPES } from './component'; // TODO: rename to assembleHeaderTitleGroup\n\nexport function assembleTitleGroup(model, channel) {\n  const title = model.component.layoutHeaders[channel].title;\n  const config = model.config ? model.config : undefined;\n  const facetFieldDef = model.component.layoutHeaders[channel].facetFieldDef ? model.component.layoutHeaders[channel].facetFieldDef : undefined;\n\n  const _getHeaderProperties = getHeaderProperties(['titleAnchor', 'titleAngle', 'titleOrient'], facetFieldDef, config, channel),\n        titleAnchor = _getHeaderProperties.titleAnchor,\n        titleAngle = _getHeaderProperties.titleAngle,\n        titleOrient = _getHeaderProperties.titleOrient;\n\n  const headerChannel = getHeaderChannel(channel, titleOrient);\n  return {\n    name: \"\".concat(channel, \"-title\"),\n    type: 'group',\n    role: \"\".concat(headerChannel, \"-title\"),\n    title: Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({\n      text: title\n    }, channel === 'row' ? {\n      orient: 'left'\n    } : {}), {\n      style: 'guide-title'\n    }), defaultHeaderGuideBaseline(titleAngle, headerChannel)), defaultHeaderGuideAlign(headerChannel, titleAngle, titleAnchor)), assembleHeaderProperties(config, facetFieldDef, channel, HEADER_TITLE_PROPERTIES, HEADER_TITLE_PROPERTIES_MAP))\n  };\n}\nexport function defaultHeaderGuideAlign(headerChannel, angle, anchor = 'middle') {\n  switch (anchor) {\n    case 'start':\n      return {\n        align: 'left'\n      };\n\n    case 'end':\n      return {\n        align: 'right'\n      };\n  }\n\n  const align = defaultLabelAlign(angle, headerChannel === 'row' ? 'left' : 'top');\n  return align ? {\n    align\n  } : {};\n}\nexport function defaultHeaderGuideBaseline(angle, channel) {\n  const baseline = defaultLabelBaseline(angle, channel === 'row' ? 'left' : 'top');\n  return baseline ? {\n    baseline\n  } : {};\n}\nexport function assembleHeaderGroups(model, channel) {\n  const layoutHeader = model.component.layoutHeaders[channel];\n  const groups = [];\n\n  for (const headerType of HEADER_TYPES) {\n    if (layoutHeader[headerType]) {\n      for (const headerCmpt of layoutHeader[headerType]) {\n        groups.push(assembleHeaderGroup(model, channel, headerType, layoutHeader, headerCmpt));\n      }\n    }\n  }\n\n  return groups;\n}\n\nfunction getSort(facetFieldDef, channel) {\n  const sort = facetFieldDef.sort;\n\n  if (isSortField(sort)) {\n    return {\n      field: vgField(sort, {\n        expr: 'datum'\n      }),\n      order: sort.order || 'ascending'\n    };\n  } else if (isArray(sort)) {\n    return {\n      field: sortArrayIndexField(facetFieldDef, channel, {\n        expr: 'datum'\n      }),\n      order: 'ascending'\n    };\n  } else {\n    return {\n      field: vgField(facetFieldDef, {\n        expr: 'datum'\n      }),\n      order: sort || 'ascending'\n    };\n  }\n}\n\nexport function assembleLabelTitle(facetFieldDef, channel, config) {\n  const _getHeaderProperties2 = getHeaderProperties(['format', 'labelAngle', 'labelAnchor', 'labelOrient', 'labelExpr'], facetFieldDef, config, channel),\n        format = _getHeaderProperties2.format,\n        labelAngle = _getHeaderProperties2.labelAngle,\n        labelAnchor = _getHeaderProperties2.labelAnchor,\n        labelOrient = _getHeaderProperties2.labelOrient,\n        labelExpr = _getHeaderProperties2.labelExpr;\n\n  const titleTextExpr = formatSignalRef(facetFieldDef, format, 'parent', config).signal;\n  const headerChannel = getHeaderChannel(channel, labelOrient);\n  return Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({\n    text: {\n      signal: labelExpr ? replaceAll(replaceAll(labelExpr, 'datum.label', titleTextExpr), 'datum.value', vgField(facetFieldDef, {\n        expr: 'parent'\n      })) : titleTextExpr\n    }\n  }, channel === 'row' ? {\n    orient: 'left'\n  } : {}), {\n    style: 'guide-label',\n    frame: 'group'\n  }), defaultHeaderGuideBaseline(labelAngle, headerChannel)), defaultHeaderGuideAlign(headerChannel, labelAngle, labelAnchor)), assembleHeaderProperties(config, facetFieldDef, channel, HEADER_LABEL_PROPERTIES, HEADER_LABEL_PROPERTIES_MAP));\n}\nexport function assembleHeaderGroup(model, channel, headerType, layoutHeader, headerCmpt) {\n  if (headerCmpt) {\n    let title = null;\n    const facetFieldDef = layoutHeader.facetFieldDef;\n    const config = model.config ? model.config : undefined;\n\n    if (facetFieldDef && headerCmpt.labels) {\n      const _getHeaderProperties3 = getHeaderProperties(['labelOrient'], facetFieldDef, config, channel),\n            labelOrient = _getHeaderProperties3.labelOrient; // Include label title in the header if orient aligns with the channel\n\n\n      if (channel === 'row' && !contains(['top', 'bottom'], labelOrient) || channel === 'column' && !contains(['left', 'right'], labelOrient)) {\n        title = assembleLabelTitle(facetFieldDef, channel, config);\n      }\n    }\n\n    const isFacetWithoutRowCol = isFacetModel(model) && !isFacetMapping(model.facet);\n    const axes = headerCmpt.axes;\n    const hasAxes = axes && axes.length > 0;\n\n    if (title || hasAxes) {\n      const sizeChannel = channel === 'row' ? 'height' : 'width';\n      return Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({\n        name: model.getName(\"\".concat(channel, \"_\").concat(headerType)),\n        type: 'group',\n        role: \"\".concat(channel, \"-\").concat(headerType)\n      }, layoutHeader.facetFieldDef ? {\n        from: {\n          data: model.getName(channel + '_domain')\n        },\n        sort: getSort(facetFieldDef, channel)\n      } : {}), hasAxes && isFacetWithoutRowCol ? {\n        from: {\n          data: model.getName(\"facet_domain_\".concat(channel))\n        }\n      } : {}), title ? {\n        title\n      } : {}), headerCmpt.sizeSignal ? {\n        encode: {\n          update: {\n            [sizeChannel]: headerCmpt.sizeSignal\n          }\n        }\n      } : {}), hasAxes ? {\n        axes\n      } : {});\n    }\n  }\n\n  return null;\n}\nconst LAYOUT_TITLE_BAND = {\n  column: {\n    start: 0,\n    end: 1\n  },\n  row: {\n    start: 1,\n    end: 0\n  }\n};\nexport function getLayoutTitleBand(titleAnchor, headerChannel) {\n  return LAYOUT_TITLE_BAND[headerChannel][titleAnchor];\n}\nexport function assembleLayoutTitleBand(headerComponentIndex, config) {\n  const titleBand = {};\n\n  for (const channel of FACET_CHANNELS) {\n    const headerComponent = headerComponentIndex[channel];\n\n    if (headerComponent && headerComponent.facetFieldDef) {\n      const _getHeaderProperties4 = getHeaderProperties(['titleAnchor', 'titleOrient'], headerComponent.facetFieldDef, config, channel),\n            titleAnchor = _getHeaderProperties4.titleAnchor,\n            titleOrient = _getHeaderProperties4.titleOrient;\n\n      const headerChannel = getHeaderChannel(channel, titleOrient);\n      const band = getLayoutTitleBand(titleAnchor, headerChannel);\n\n      if (band !== undefined) {\n        titleBand[headerChannel] = band;\n      }\n    }\n  }\n\n  return keys(titleBand).length > 0 ? titleBand : undefined;\n}\nexport function assembleHeaderProperties(config, facetFieldDef, channel, properties, propertiesMap) {\n  const props = {};\n\n  for (const prop of properties) {\n    if (!propertiesMap[prop]) {\n      continue;\n    }\n\n    const value = getHeaderProperty(prop, facetFieldDef, config, channel);\n\n    if (value !== undefined) {\n      props[propertiesMap[prop]] = value;\n    }\n  }\n\n  return props;\n}","map":null,"metadata":{},"sourceType":"module"}